name: CI/CD Pipeline

on:
  push:
    branches:
      - master
  schedule:
    - cron: '10 12 * * *'

jobs:
  setup:
    runs-on: self-hosted
    outputs:
      version: ${{ steps.set_version.outputs.version }}
    steps:
      - name: Get Date
        id: set_version
        run: echo "::set-output name=version::$(date +'%Y%m%d').${{ github.run_number }}"



  build:
    runs-on: self-hosted
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Build with Maven
      run: mvn clean package -DartifactVersion=${{ needs.setup.outputs.version }}

  test:
    needs: build
    runs-on: self-hosted
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Run Maven Tests
      run: mvn test -DartifactVersion=${{ needs.setup.outputs.version }}

  deploy:
    needs: test
    runs-on: self-hosted
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Deploy to Nexus
      run: |
        mvn deploy -Dmaven.deploy.skip=true -DartifactVersion=${{ needs.setup.outputs.version }}
        mvn deploy:deploy-file -Durl=http://localhost:8081/repository/maven-releases/ -DrepositoryId=maven-releases -Dfile=${{ github.workspace }}/warfiles/petclinic.war -DgroupId=org.springframework.samples -DartifactId=spring-framework-petclinic -Dversion=${{ github.run_number }} -Dpackaging=war -DgeneratePom=false -DuniqueVersion=false

    - name: Run JMeter Tests
      run: /home/diarhussein/Downloads/apache-jmeter-5.6.2/bin/jmeter -n -t /home/diarhussein/Downloads/devoteam-traineeship-petclinic/src/test/jmeter/JMetertest.jmx

    - name: Publish JMeter Test Results
      uses: actions/upload-artifact@v2
      with:
        name: jmeter-tests
        path: '**/TEST-*.xml'

  selenium-test:
    needs: deploy
    runs-on: self-hosted
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install Selenium
      run: pip install selenium

    - name: Execute Selenium Tests
      run: python /home/diarhussein/Downloads/devoteam-traineeship-petclinic/test_petclinic.py
